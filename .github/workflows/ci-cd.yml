name: CI/CD Pipeline

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'
      - 'LICENSE'

env:
  DOCKER_IMAGE: tlesmes/teammoa-web
  DOCKER_TAG: latest

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_root_pass
          MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create .env file for testing
        run: |
          cat > .env << EOF
          SECRET_KEY=test-secret-key-for-github-actions
          DEBUG=True
          ALLOWED_HOSTS=localhost,127.0.0.1

          # Database
          DB_ENGINE=django.db.backends.mysql
          DB_NAME=test_db
          DB_USER=root
          DB_PASSWORD=test_root_pass
          DB_HOST=127.0.0.1
          DB_PORT=3306

          # Redis
          REDIS_HOST=127.0.0.1
          REDIS_PORT=6379
          REDIS_PASSWORD=

          # Email (dummy for testing)
          EMAIL_HOST=smtp.gmail.com
          EMAIL_PORT=587
          EMAIL_HOST_USER=test@example.com
          EMAIL_HOST_PASSWORD=test_password

          # OAuth (dummy for testing)
          GOOGLE_OAUTH_CLIENT_ID=dummy
          GOOGLE_OAUTH_CLIENT_SECRET=dummy
          GITHUB_OAUTH_CLIENT_ID=dummy
          GITHUB_OAUTH_CLIENT_SECRET=dummy
          EOF

      - name: Run migrations
        env:
          DJANGO_SETTINGS_MODULE: TeamMoa.settings.dev
        run: |
          python manage.py migrate --noinput

      - name: Run tests and generate stats
        env:
          DJANGO_SETTINGS_MODULE: TeamMoa.settings.dev
        run: |
          pytest -v --tb=short --generate-stats

      - name: Update documentation with test stats
        run: python scripts/update_test_docs.py

      - name: Check for documentation changes
        id: check_docs
        run: |
          git diff --quiet docs/ README.md CLAUDE.md || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit and push documentation updates
        if: steps.check_docs.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/ README.md CLAUDE.md
          git commit -m "docs: í…ŒìŠ¤íŠ¸ í†µê³„ ìë™ ì—…ë°ì´íŠ¸ [skip ci]"
          git push

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache,mode=max

  deploy:
    name: Deploy to ALB (Rolling Update)
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get Public IP
        id: ip
        uses: haythem/public-ip@v1.3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: 'ap-northeast-2'

      - name: Add GitHub Actions IP to Web security group
        run: |
          aws ec2 authorize-security-group-ingress \
              --group-id ${{ secrets.WEB_SECURITY_GROUP_ID }} \
              --protocol tcp \
              --port 22 \
              --cidr ${{ steps.ip.outputs.ipv4 }}/32

          echo "â³ Waiting for security group rule to propagate (10s)..."
          sleep 10

      # ========================================
      # Web1 ë°°í¬
      # ========================================
      - name: "ğŸ“¦ Deploy Web1: Get Public IP"
        id: web1_ip
        run: |
          WEB1_IP=$(aws ec2 describe-instances \
              --instance-ids ${{ secrets.EC2_WEB1_ID }} \
              --query 'Reservations[0].Instances[0].PublicIpAddress' \
              --output text)
          echo "Web1 Public IP: $WEB1_IP"
          echo "ip=$WEB1_IP" >> $GITHUB_OUTPUT

      - name: "ğŸ“¦ Deploy Web1: Deregister from Target Group"
        run: |
          echo "ğŸ”„ Removing Web1 from Target Group..."
          aws elbv2 deregister-targets \
              --target-group-arn ${{ secrets.TARGET_GROUP_ARN }} \
              --targets Id=${{ secrets.EC2_WEB1_ID }},Port=80

          echo "â³ Waiting for connection draining (30s)..."
          sleep 30

          echo "âœ… Web1 deregistered"

      - name: "ğŸ“¦ Deploy Web1: Deploy via SSH"
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.web1_ip.outputs.ip }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            sed -i 's/\r$//' ~/TeamMoa/scripts/deploy_web_server.sh
            chmod +x ~/TeamMoa/scripts/deploy_web_server.sh
            ~/TeamMoa/scripts/deploy_web_server.sh

      - name: "ğŸ“¦ Deploy Web1: Register to Target Group"
        run: |
          echo "ğŸ”„ Adding Web1 back to Target Group..."
          aws elbv2 register-targets \
              --target-group-arn ${{ secrets.TARGET_GROUP_ARN }} \
              --targets Id=${{ secrets.EC2_WEB1_ID }},Port=80

          echo "â³ Waiting for Target to become healthy (60s)..."
          sleep 60

          # Target Health í™•ì¸
          HEALTH_STATE=$(aws elbv2 describe-target-health \
              --target-group-arn ${{ secrets.TARGET_GROUP_ARN }} \
              --targets Id=${{ secrets.EC2_WEB1_ID }},Port=80 \
              --query 'TargetHealthDescriptions[0].TargetHealth.State' \
              --output text)

          echo "Web1 Target Health: $HEALTH_STATE"

          if [ "$HEALTH_STATE" != "healthy" ]; then
            echo "âŒ Web1 failed to become healthy in Target Group"
            exit 1
          fi

          echo "âœ… Web1 is healthy and serving traffic"

      # ========================================
      # Web2 ë°°í¬
      # ========================================
      - name: "ğŸ“¦ Deploy Web2: Get Public IP"
        id: web2_ip
        run: |
          WEB2_IP=$(aws ec2 describe-instances \
              --instance-ids ${{ secrets.EC2_WEB2_ID }} \
              --query 'Reservations[0].Instances[0].PublicIpAddress' \
              --output text)
          echo "Web2 Public IP: $WEB2_IP"
          echo "ip=$WEB2_IP" >> $GITHUB_OUTPUT

      - name: "ğŸ“¦ Deploy Web2: Deregister from Target Group"
        run: |
          echo "ğŸ”„ Removing Web2 from Target Group..."
          aws elbv2 deregister-targets \
              --target-group-arn ${{ secrets.TARGET_GROUP_ARN }} \
              --targets Id=${{ secrets.EC2_WEB2_ID }},Port=80

          echo "â³ Waiting for connection draining (30s)..."
          sleep 30

          echo "âœ… Web2 deregistered"

      - name: "ğŸ“¦ Deploy Web2: Deploy via SSH"
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.web2_ip.outputs.ip }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            sed -i 's/\r$//' ~/TeamMoa/scripts/deploy_web_server.sh
            chmod +x ~/TeamMoa/scripts/deploy_web_server.sh
            ~/TeamMoa/scripts/deploy_web_server.sh

      - name: "ğŸ“¦ Deploy Web2: Register to Target Group"
        run: |
          echo "ğŸ”„ Adding Web2 back to Target Group..."
          aws elbv2 register-targets \
              --target-group-arn ${{ secrets.TARGET_GROUP_ARN }} \
              --targets Id=${{ secrets.EC2_WEB2_ID }},Port=80

          echo "â³ Waiting for Target to become healthy (60s)..."
          sleep 60

          # Target Health í™•ì¸
          HEALTH_STATE=$(aws elbv2 describe-target-health \
              --target-group-arn ${{ secrets.TARGET_GROUP_ARN }} \
              --targets Id=${{ secrets.EC2_WEB2_ID }},Port=80 \
              --query 'TargetHealthDescriptions[0].TargetHealth.State' \
              --output text)

          echo "Web2 Target Health: $HEALTH_STATE"

          if [ "$HEALTH_STATE" != "healthy" ]; then
            echo "âŒ Web2 failed to become healthy in Target Group"
            exit 1
          fi

          echo "âœ… Web2 is healthy and serving traffic"

      # ========================================
      # ìµœì¢… í™•ì¸
      # ========================================
      - name: "âœ… Verify deployment"
        run: |
          echo "=================================================="
          echo "ğŸ‰ Rolling Update Deployment Completed!"
          echo "=================================================="
          echo ""
          echo "ğŸ“Š Final Target Group Status:"
          aws elbv2 describe-target-health \
              --target-group-arn ${{ secrets.TARGET_GROUP_ARN }} \
              --query 'TargetHealthDescriptions[].{Target:Target.Id,Port:Target.Port,State:TargetHealth.State}' \
              --output table

          echo ""
          echo "âœ… Both Web1 and Web2 are now running the latest version"

      - name: Remove GitHub Actions IP from security group
        if: always()
        run: |
          aws ec2 revoke-security-group-ingress \
              --group-id ${{ secrets.WEB_SECURITY_GROUP_ID }} \
              --protocol tcp \
              --port 22 \
              --cidr ${{ steps.ip.outputs.ipv4 }}/32
        continue-on-error: true