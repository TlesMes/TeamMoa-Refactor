{% extends 'base_app.html' %} 
{% load static %} 

{% block contents %}
<section class="page-section schedule-upload-page">
  <div class="content-card">
    <div class="card-header">
      <a href="{% url 'schedules:scheduler_page' team.id %}" class="back-btn">
        <i class="ri-arrow-left-line"></i>
      </a>
      <h2>스케줄 업로드</h2>
      <p>나의 가능한 시간대를 선택하여 팀 스케줄에 등록하세요</p>
    </div>

    <div class="info-section">
      <div class="phase-info-section">
        <div class="phase-icon">
          <i class="ri-calendar-upload-line"></i>
        </div>
        <div class="phase-description">
          <h4>개인 스케줄 등록</h4>
          <p>가능한 시간대를 체크하면 팀원들과 함께 최적의 모임 시간을 찾을 수 있습니다.</p>
        </div>
      </div>
    </div>
    
    <form method="POST" action="." class="form-container">
      {% csrf_token %}
      
      <div class="form-group">
        <label for="week">주차 선택</label>
        <div class="input-wrapper">
          <i class="ri-calendar-2-line"></i>
          <input type="week" name="week" id="week" required>
        </div>
        <div class="help-text">
          <small>스케줄을 등록할 주차를 선택해주세요</small>
        </div>
      </div>

      <div class="schedule-grid-container">
        <h4>가능한 시간대 선택</h4>
        <p class="schedule-instruction">체크박스를 클릭하여 가능한 시간을 표시해주세요</p>
        
        <div class="schedule-grid-wrapper">
          <div class="schedule-grid">
            <!-- Time column header -->
          <div class="time-column">
            <div class="time-header">시간</div>
            {% for hour in "012345678901234567890123"|make_list %}
              <div class="time-slot">
                {% if forloop.counter0 == 0 %}12:00 AM
                {% elif forloop.counter0 < 12 %}{{ forloop.counter0|stringformat:"02d" }}:00 AM
                {% elif forloop.counter0 == 12 %}12:00 PM
                {% else %}{{ forloop.counter0|add:"-12"|stringformat:"02d" }}:00 PM
                {% endif %}
              </div>
            {% endfor %}
          </div>

          <!-- Days columns -->
          <div class="day-column">
            <div class="day-header" data-day="1">
              <div class="date-line">-/-</div>
              <div class="day-line">(월)</div>
            </div>
            {% for hour in "012345678901234567890123"|make_list %}
              <label class="schedule-slot" for="id_time_{{ forloop.counter0 }}_1">
                <input type="checkbox" 
                       name="time_{{ forloop.counter0 }}-1" 
                       id="id_time_{{ forloop.counter0 }}_1"
                       class="schedule-checkbox" />
                <span class="slot-indicator">
                  <i class="ri-check-line"></i>
                </span>
              </label>
            {% endfor %}
          </div>

          <div class="day-column">
            <div class="day-header" data-day="2">
              <div class="date-line">-/-</div>
              <div class="day-line">(화)</div>
            </div>
            {% for hour in "012345678901234567890123"|make_list %}
              <label class="schedule-slot" for="id_time_{{ forloop.counter0 }}_2">
                <input type="checkbox" 
                       name="time_{{ forloop.counter0 }}-2" 
                       id="id_time_{{ forloop.counter0 }}_2"
                       class="schedule-checkbox" />
                <span class="slot-indicator">
                  <i class="ri-check-line"></i>
                </span>
              </label>
            {% endfor %}
          </div>

          <div class="day-column">
            <div class="day-header" data-day="3">
              <div class="date-line">-/-</div>
              <div class="day-line">(수)</div>
            </div>
            {% for hour in "012345678901234567890123"|make_list %}
              <label class="schedule-slot" for="id_time_{{ forloop.counter0 }}_3">
                <input type="checkbox" 
                       name="time_{{ forloop.counter0 }}-3" 
                       id="id_time_{{ forloop.counter0 }}_3"
                       class="schedule-checkbox" />
                <span class="slot-indicator">
                  <i class="ri-check-line"></i>
                </span>
              </label>
            {% endfor %}
          </div>

          <div class="day-column">
            <div class="day-header" data-day="4">
              <div class="date-line">-/-</div>
              <div class="day-line">(목)</div>
            </div>
            {% for hour in "012345678901234567890123"|make_list %}
              <label class="schedule-slot" for="id_time_{{ forloop.counter0 }}_4">
                <input type="checkbox" 
                       name="time_{{ forloop.counter0 }}-4" 
                       id="id_time_{{ forloop.counter0 }}_4"
                       class="schedule-checkbox" />
                <span class="slot-indicator">
                  <i class="ri-check-line"></i>
                </span>
              </label>
            {% endfor %}
          </div>

          <div class="day-column">
            <div class="day-header" data-day="5">
              <div class="date-line">-/-</div>
              <div class="day-line">(금)</div>
            </div>
            {% for hour in "012345678901234567890123"|make_list %}
              <label class="schedule-slot" for="id_time_{{ forloop.counter0 }}_5">
                <input type="checkbox" 
                       name="time_{{ forloop.counter0 }}-5" 
                       id="id_time_{{ forloop.counter0 }}_5"
                       class="schedule-checkbox" />
                <span class="slot-indicator">
                  <i class="ri-check-line"></i>
                </span>
              </label>
            {% endfor %}
          </div>

          <div class="day-column">
            <div class="day-header" data-day="6">
              <div class="date-line">-/-</div>
              <div class="day-line">(토)</div>
            </div>
            {% for hour in "012345678901234567890123"|make_list %}
              <label class="schedule-slot" for="id_time_{{ forloop.counter0 }}_6">
                <input type="checkbox" 
                       name="time_{{ forloop.counter0 }}-6" 
                       id="id_time_{{ forloop.counter0 }}_6"
                       class="schedule-checkbox" />
                <span class="slot-indicator">
                  <i class="ri-check-line"></i>
                </span>
              </label>
            {% endfor %}
          </div>

          <div class="day-column">
            <div class="day-header" data-day="0">
              <div class="date-line">-/-</div>
              <div class="day-line">(일)</div>
            </div>
            {% for hour in "012345678901234567890123"|make_list %}
              <label class="schedule-slot" for="id_time_{{ forloop.counter0 }}_7">
                <input type="checkbox" 
                       name="time_{{ forloop.counter0 }}-7" 
                       id="id_time_{{ forloop.counter0 }}_7"
                       class="schedule-checkbox" />
                <span class="slot-indicator">
                  <i class="ri-check-line"></i>
                </span>
              </label>
            {% endfor %}
          </div>
          </div>
        </div>

        <!-- Quick selection tools -->
        <div class="selection-tools">
          <h5>빠른 선택 도구</h5>
          <div class="tools-grid">
            <button type="button" class="tool-btn" onclick="selectAllSlots()">
              <i class="ri-check-double-line"></i>
              전체 선택
            </button>
            <button type="button" class="tool-btn" onclick="clearAllSlots()">
              <i class="ri-close-line"></i>
              전체 해제
            </button>
            <button type="button" class="tool-btn" onclick="selectWorkingHours()">
              <i class="ri-briefcase-line"></i>
              업무시간 (9-18시)
            </button>
            <button type="button" class="tool-btn" onclick="selectEveningHours()">
              <i class="ri-moon-line"></i>
              저녁시간 (18-22시)
            </button>
            <button type="button" class="tool-btn" onclick="selectWeekdays()">
              <i class="ri-calendar-check-line"></i>
              평일만
            </button>
            <button type="button" class="tool-btn" onclick="selectWeekends()">
              <i class="ri-calendar-2-line"></i>
              주말만
            </button>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="create-btn">
          <i class="ri-upload-line"></i>
          스케줄 업로드
        </button>
        <a href="{% url 'schedules:scheduler_page' team.id %}" class="cancel-btn">
          <i class="ri-close-line"></i>
          취소
        </a>
      </div>
    </form>
  </div>

  {% if messages %}
    <div class="messages-container">
      {% for message in messages %}
        <div class="message message-{{ message.tags }}">
          <i class="ri-information-line"></i>
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
</section>

<script>
// 빠른 선택 도구 JavaScript 함수들
function selectAllSlots() {
  document.querySelectorAll('.schedule-checkbox').forEach(checkbox => {
    checkbox.checked = true;
    checkbox.dispatchEvent(new Event('change'));
  });
}

function clearAllSlots() {
  document.querySelectorAll('.schedule-checkbox').forEach(checkbox => {
    checkbox.checked = false;
    checkbox.dispatchEvent(new Event('change'));
  });
}

function selectWorkingHours() {
  clearAllSlots();
  // 9시부터 18시까지 (인덱스 9-17)
  for (let hour = 9; hour <= 17; hour++) {
    for (let day = 1; day <= 7; day++) {
      const checkbox = document.getElementById(`id_time_${hour}_${day}`);
      if (checkbox) {
        checkbox.checked = true;
        checkbox.dispatchEvent(new Event('change'));
      }
    }
  }
}

function selectEveningHours() {
  clearAllSlots();
  // 18시부터 22시까지 (인덱스 18-21)
  for (let hour = 18; hour <= 21; hour++) {
    for (let day = 1; day <= 7; day++) {
      const checkbox = document.getElementById(`id_time_${hour}_${day}`);
      if (checkbox) {
        checkbox.checked = true;
        checkbox.dispatchEvent(new Event('change'));
      }
    }
  }
}

function selectWeekdays() {
  // 월요일(1)부터 금요일(5)까지
  document.querySelectorAll('.schedule-checkbox').forEach(checkbox => {
    const name = checkbox.name;
    const dayMatch = name.match(/time_\d+-(\d+)/);
    if (dayMatch) {
      const day = parseInt(dayMatch[1]);
      checkbox.checked = (day >= 1 && day <= 5);
      checkbox.dispatchEvent(new Event('change'));
    }
  });
}

function selectWeekends() {
  // 토요일(6), 일요일(7)
  document.querySelectorAll('.schedule-checkbox').forEach(checkbox => {
    const name = checkbox.name;
    const dayMatch = name.match(/time_\d+-(\d+)/);
    if (dayMatch) {
      const day = parseInt(dayMatch[1]);
      checkbox.checked = (day === 6 || day === 7);
      checkbox.dispatchEvent(new Event('change'));
    }
  });
}

// 드래그 선택 기능
let isDragging = false;
let dragMode = null; // 'select' 또는 'deselect'
let dragStartSlot = null; // 드래그 시작 슬롯
let hasMoved = false; // 드래그 중 실제로 움직였는지 확인

// 주차 선택 시 날짜 업데이트
function updateWeekDates(weekValue) {
  if (!weekValue) return;
  
  // YYYY-W## 형식을 파싱
  const [year, week] = weekValue.split('-W');
  
  // 해당 주차의 월요일 계산
  const jan1 = new Date(year, 0, 1);
  const dayOfWeek = jan1.getDay() || 7; // 월요일 = 1, 일요일 = 7
  const mondayOfFirstWeek = new Date(year, 0, 1 + (8 - dayOfWeek) % 7);
  const mondayOfTargetWeek = new Date(mondayOfFirstWeek.getTime() + (week - 1) * 7 * 24 * 60 * 60 * 1000);
  
  // 각 요일의 날짜 계산 및 업데이트
  for (let i = 0; i < 7; i++) {
    const currentDate = new Date(mondayOfTargetWeek.getTime() + i * 24 * 60 * 60 * 1000);
    const dayOfWeek = i === 6 ? 0 : i + 1; // 일요일은 0, 월~토는 1~6
    
    const header = document.querySelector(`[data-day="${dayOfWeek}"]`);
    if (header) {
      const dateLine = header.querySelector('.date-line');
      if (dateLine) {
        dateLine.textContent = `${currentDate.getMonth() + 1}/${currentDate.getDate()}`;
      }
    }
  }
}

// 체크박스 상태 변경 시 시각적 피드백 (구형 브라우저 지원)
document.addEventListener('DOMContentLoaded', function() {
  const weekInput = document.getElementById('week');
  
  // 주차 입력 변경 시 날짜 업데이트
  if (weekInput) {
    weekInput.addEventListener('change', function() {
      updateWeekDates(this.value);
    });
    
    // 초기값이 있으면 업데이트
    if (weekInput.value) {
      updateWeekDates(weekInput.value);
    }
  }
  const scheduleGrid = document.querySelector('.schedule-grid');
  
  // 개별 클릭 처리
  document.querySelectorAll('.schedule-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const slot = this.closest('.schedule-slot');
      updateSlotVisual(slot, this.checked);
    });
  });

  // 드래그 시작 (마우스)
  scheduleGrid.addEventListener('mousedown', function(e) {
    if (e.target.closest('.schedule-slot')) {
      const slot = e.target.closest('.schedule-slot');
      const checkbox = slot.querySelector('input[type="checkbox"]');
      
      isDragging = true;
      dragStartSlot = slot;
      hasMoved = false;
      
      // 드래그 모드 결정 (현재 상태의 반대)
      dragMode = checkbox.checked ? 'deselect' : 'select';
      
      // 첫 번째 슬롯 토글
      toggleSlot(slot);
      
      // 드래그 시각적 피드백
      scheduleGrid.classList.add('dragging');
      
      e.preventDefault(); // 텍스트 선택 방지
    }
  });

  // 드래그 중 (마우스)
  scheduleGrid.addEventListener('mouseover', function(e) {
    if (isDragging && e.target.closest('.schedule-slot')) {
      const slot = e.target.closest('.schedule-slot');
      const checkbox = slot.querySelector('input[type="checkbox"]');
      
      // 시작 슬롯이 아닌 경우에만 처리
      if (slot !== dragStartSlot) {
        hasMoved = true;
        
        // 드래그 모드에 따라 선택/해제
        if (dragMode === 'select' && !checkbox.checked) {
          checkbox.checked = true;
          checkbox.dispatchEvent(new Event('change'));
        } else if (dragMode === 'deselect' && checkbox.checked) {
          checkbox.checked = false;
          checkbox.dispatchEvent(new Event('change'));
        }
      }
    }
  });

  // 드래그 끝 (마우스)
  document.addEventListener('mouseup', function(e) {
    if (isDragging) {
      const slot = e.target.closest('.schedule-slot');
      
      // 시작점에서 끝났고 실제로 이동하지 않았다면 (단일 클릭)
      if (slot === dragStartSlot) {
        // 시작점의 토글을 되돌림 (단일 클릭 무효화)
        toggleSlot(dragStartSlot);
      }
      
      // 드래그는 무조건 중지
      isDragging = false;
      dragMode = null;
      dragStartSlot = null;
      hasMoved = false;
      scheduleGrid.classList.remove('dragging');
    }
  });

  // 터치 이벤트 (모바일 지원)
  scheduleGrid.addEventListener('touchstart', function(e) {
    if (e.target.closest('.schedule-slot')) {
      const slot = e.target.closest('.schedule-slot');
      const checkbox = slot.querySelector('input[type="checkbox"]');
      
      isDragging = true;
      dragStartSlot = slot;
      hasMoved = false;
      
      dragMode = checkbox.checked ? 'deselect' : 'select';
      toggleSlot(slot);
      
      e.preventDefault();
    }
  });

  scheduleGrid.addEventListener('touchmove', function(e) {
    if (isDragging) {
      e.preventDefault();
      const touch = e.touches[0];
      const element = document.elementFromPoint(touch.clientX, touch.clientY);
      const slot = element?.closest('.schedule-slot');
      
      if (slot && slot !== dragStartSlot) {
        hasMoved = true;
        const checkbox = slot.querySelector('input[type="checkbox"]');
        if (dragMode === 'select' && !checkbox.checked) {
          checkbox.checked = true;
          checkbox.dispatchEvent(new Event('change'));
        } else if (dragMode === 'deselect' && checkbox.checked) {
          checkbox.checked = false;
          checkbox.dispatchEvent(new Event('change'));
        }
      }
    }
  });

  document.addEventListener('touchend', function(e) {
    if (isDragging) {
      // 터치 종료 시점의 요소 확인
      const touch = e.changedTouches[0];
      const element = document.elementFromPoint(touch.clientX, touch.clientY);
      const slot = element?.closest('.schedule-slot');
      
      // 시작점에서 끝났다면 (단일 터치이든 드래그 후 복귀든)
      if (slot === dragStartSlot) {
        // 시작점의 토글을 되돌림
        toggleSlot(dragStartSlot);
      }
      
      // 드래그는 무조건 중지
      isDragging = false;
      dragMode = null;
      dragStartSlot = null;
      hasMoved = false;
      scheduleGrid.classList.remove('dragging');
    }
  });

  // 드래그 중 선택 방지
  scheduleGrid.addEventListener('selectstart', function(e) {
    if (isDragging) {
      e.preventDefault();
    }
  });
});

// 슬롯 토글 함수
function toggleSlot(slot) {
  const checkbox = slot.querySelector('input[type="checkbox"]');
  checkbox.checked = !checkbox.checked;
  checkbox.dispatchEvent(new Event('change'));
}

// 슬롯 시각적 업데이트 함수
function updateSlotVisual(slot, isChecked) {
  if (isChecked) {
    slot.classList.add('selected');
  } else {
    slot.classList.remove('selected');
  }
}
</script>
{% endblock %}