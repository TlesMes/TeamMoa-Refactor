# ================================================================
# Nginx Configuration for AWS ALB Environment
# ================================================================
#
# ALB에서 HTTPS 종료 (SSL Offloading) 방식:
#   - ALB: HTTPS (443) 처리 + ACM 인증서 사용
#   - Nginx: HTTP (80)만 수신, ALB로부터 트래픽 수신
#
# 주요 특징:
#   - 각 EC2에 SSL 인증서 관리 불필요
#   - ALB Health Check: HTTP:80/nginx-health
#   - X-Forwarded-Proto 헤더로 HTTPS 요청 판별
#   - www → non-www 리디렉션 (SEO 정규화)
# ================================================================

# Upstream Django application
upstream teammoa_app {
    server web:8000;
}

# www → non-www 리디렉션
server {
    listen 80;
    server_name www.teammoa.shop;

    # X-Forwarded-Proto가 https이면 https://teammoa.shop으로 리디렉션
    # X-Forwarded-Proto가 http이거나 없으면 http://teammoa.shop으로 리디렉션 (Health Check 대응)
    set $redirect_scheme $scheme;
    if ($http_x_forwarded_proto = 'https') {
        set $redirect_scheme https;
    }

    return 301 $redirect_scheme://teammoa.shop$request_uri;
}

# HTTP server (ALB에서 트래픽 수신)
server {
    listen 80;
    server_name teammoa.shop teammoa.duckdns.org;

    # Nginx health check endpoint (ALB Target Group Health Check)
    location /nginx-health {
        access_log off;
        return 200 "Nginx OK\n";
        add_header Content-Type text/plain;
    }

    # Django health check endpoint (application monitoring)
    location /health/ {
        access_log off;
        proxy_pass http://teammoa_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
    }

    # Security headers (ALB HTTPS 환경에서도 적용)
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # WebSocket 전용 location (우선순위 높음)
    location /ws/ {
        proxy_pass http://teammoa_app;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;

        # WebSocket 타임아웃 설정 (긴 연결 유지)
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;

        # WebSocket 버퍼링 비활성화
        proxy_buffering off;
    }

    location / {
        proxy_pass http://teammoa_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;

        # 일반 HTTP 타임아웃
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    location /static/ {
        alias /app/staticfiles/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    location /media/ {
        alias /app/media/;
        expires 7d;
        add_header Cache-Control "public";
    }
}
