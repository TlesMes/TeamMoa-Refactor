{% extends 'base_app.html' %}
{% load static %}
{% csrf_token %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/teams.css' %}" />
{% endblock %}

{% block contents %}
<section class="timeline-page">
  <div class="timeline-page-header">
    <div class="timeline-header-left">
      <a href="{% url 'teams:team_main_page' team.id %}" class="back-btn">
        <i class="ri-arrow-left-line"></i>
      </a>
      <div class="timeline-title-section">
        <h2>마일스톤 타임라인</h2>
        <p>팀의 마일스톤을 시각적 타임라인으로 관리하세요</p>
      </div>
    </div>
    <a href="{% url 'teams:team_add_milestone' team.id %}" class="primary-btn">
      <i class="ri-add-line"></i>
      마일스톤 추가
    </a>
  </div>

  <div class="timeline-container">
    <!-- 좌측 고정 영역: 마일스톤 정보 -->
    <div class="milestone-info-fixed">
      <div class="milestone-info-header">
        <h3>마일스톤</h3>
      </div>
      <div class="milestone-info-list">
        {% for milestone in milestones %}
        <div class="milestone-info-item" data-milestone-id="{{ milestone.id }}">
          <div class="milestone-title">{{ milestone.title }}</div>
          <div class="milestone-dates">
            <span class="date-range">{{ milestone.startdate|date:'m/d' }} - {{ milestone.enddate|date:'m/d' }}</span>
          </div>
          <div class="milestone-meta">
            <span class="priority priority-{{ milestone.priority }}">
              {{ milestone.get_priority_display }}
            </span>
            <span class="progress">{{ milestone.progress_percentage }}%</span>
          </div>
        </div>
        {% empty %}
        <div class="empty-milestone-info">
          <p>아직 등록된 마일스톤이 없습니다</p>
        </div>
        {% endfor %}
      </div>
    </div>
    
    <!-- 우측 스크롤 영역: 타임라인 -->
    <div class="timeline-scroll-area">
      <div class="timeline-scroll-content">
        <!-- 헤더 높이 맞춤용 빈 영역 -->
        <div class="timeline-header-spacer" id="monthHeaders">
          <!-- JavaScript로 동적 생성 -->
        </div>
        
        <!-- 마일스톤 타임라인 -->
        {% for milestone in milestones %}
        <div class="milestone-timeline-item" data-milestone-id="{{ milestone.id }}" 
             data-start="{{ milestone.startdate|date:'Y-m-d' }}"
             data-end="{{ milestone.enddate|date:'Y-m-d' }}">
          <div class="milestone-bar priority-{{ milestone.priority }} 
                     {% if milestone.is_completed %}completed{% endif %}">
            {% comment %} <span>{{ milestone.startdate|date:'m/d' }} - {{ milestone.enddate|date:'m/d' }}</span> {% endcomment %}
          </div>
        </div>
        {% empty %}
        <div class="empty-timeline">
          <i class="ri-calendar-todo-line"></i>
          <p>아직 등록된 마일스톤이 없습니다</p>
          <a href="{% url 'teams:team_add_milestone' team.id %}" class="primary-btn">
            첫 번째 마일스톤 추가하기
          </a>
        </div>
        {% endfor %}
        
        <!-- 월별 구분선 - JavaScript로 동적 생성 -->
        
        <!-- 일별 구분선 (디버깅용) -->
      </div>
    </div>
  </div>
  </div>
</section>

<!-- 마일스톤 상세 모달 -->
<div class="modal" id="milestoneModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">마일스톤 상세</h3>
      <button class="modal-close" id="modalClose">
        <i class="ri-close-line"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="milestone-detail" id="milestoneDetail">
        <!-- JavaScript로 동적 생성 -->
      </div>
    </div>
  </div>
</div>

<script>
// 월별 실제 일수 기반 타임라인 시스템
document.addEventListener('DOMContentLoaded', function() {
    const scrollContent = document.querySelector('.timeline-scroll-content');
    const monthHeaders = document.getElementById('monthHeaders');
    const currentYear = new Date().getFullYear();
    const dayWidth = 12; // 일당 픽셀 너비
    
    // 각 월의 일수 계산 (윤년 고려)
    function getDaysInMonth(year, month) {
        return new Date(year, month + 1, 0).getDate();
    }
    
    // 월별 일수 배열과 누적 위치 계산
    const monthDays = [];
    const monthOffsets = [];
    let totalOffset = 0;
    
    for (let month = 0; month < 12; month++) {
        monthOffsets[month] = totalOffset;
        const daysInMonth = getDaysInMonth(currentYear, month);
        monthDays[month] = daysInMonth;
        totalOffset += daysInMonth * dayWidth;
    }
    
    const totalWidth = totalOffset;
    console.log('월별 일수:', monthDays);
    console.log('월별 시작 위치:', monthOffsets);
    console.log('총 타임라인 너비:', totalWidth);
    
    // 월별 헤더 동적 생성
    for (let month = 0; month < 12; month++) {
        const monthHeader = document.createElement('div');
        monthHeader.className = 'month-header';
        monthHeader.textContent = `${month + 1}월`;
        monthHeader.style.cssText = `
            position: absolute;
            left: ${monthOffsets[month]}px;
            width: ${monthDays[month] * dayWidth}px;
        `;
        monthHeaders.appendChild(monthHeader);
    }
    
    // 월별 구분선 동적 생성
    for (let month = 1; month < 12; month++) { // 1월부터 시작 (0월 제외)
        const monthMarker = document.createElement('div');
        monthMarker.className = 'month-marker';
        monthMarker.style.cssText = `
            position: absolute;
            left: ${monthOffsets[month]}px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #8c9399;
            pointer-events: none;
        `;
        scrollContent.appendChild(monthMarker);
    }
    
    // 일별 구분선 생성 (디버깅용)
    for (let month = 0; month < 12; month++) {
        for (let day = 1; day <= monthDays[month]; day++) {
            const dayPos = monthOffsets[month] + ((day - 1) * dayWidth);
            const dayMarker = document.createElement('div');
            dayMarker.className = 'day-marker';
            dayMarker.style.cssText = `
                position: absolute;
                left: ${dayPos}px;
                top: 0;
                bottom: 0;
                width: 1px;
                background: rgba(200, 200, 200, 0.3);
                pointer-events: none;
            `;
            scrollContent.appendChild(dayMarker);
        }
    }
    
    // 타임라인 컨테이너 너비 설정
    scrollContent.style.width = totalWidth + 'px';
    
    const milestoneItems = document.querySelectorAll('.milestone-timeline-item');
    
    // 날짜 <-> 픽셀 변환 함수들 (새로운 월별 오프셋 기반)
    function dateToPixel(date) {
        const month = date.getMonth();
        const day = date.getDate();
        return monthOffsets[month] + ((day - 1) * dayWidth);
    }
    
    function pixelToDate(pixel) {
        // 어느 월에 속하는지 찾기
        let month = 0;
        for (let m = 0; m < 12; m++) {
            if (pixel >= monthOffsets[m] && (m === 11 || pixel < monthOffsets[m + 1])) {
                month = m;
                break;
            }
        }
        
        // 해당 월 내에서의 일수 계산
        const dayInMonth = Math.floor((pixel - monthOffsets[month]) / dayWidth) + 1;
        const validDay = Math.min(Math.max(dayInMonth, 1), monthDays[month]);
        
        return new Date(currentYear, month, validDay);
    }
    
    function formatDate(date) {
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    }
    
    // 날짜를 디스플레이용으로 포맷팅
    function formatDateForDisplay(date) {
        return `${date.getMonth() + 1}월 ${date.getDate()}일`;
    }
    
    // 픽셀 위치를 가장 가까운 일(day) 단위로 스냅
    function snapToDay(pixel) {
        // 어느 월에 속하는지 찾기
        let month = 0;
        for (let m = 0; m < 12; m++) {
            if (pixel >= monthOffsets[m] && (m === 11 || pixel < monthOffsets[m + 1])) {
                month = m;
                break;
            }
        }
        
        // 해당 월 내에서의 일수 계산하고 반올림
        const pixelInMonth = pixel - monthOffsets[month];
        const dayInMonth = Math.round(pixelInMonth / dayWidth);
        const validDay = Math.min(Math.max(dayInMonth, 0), monthDays[month] - 1);
        
        return monthOffsets[month] + (validDay * dayWidth);
    }
    
    milestoneItems.forEach(item => {
        const startDate = new Date(item.dataset.start);
        const endDate = new Date(item.dataset.end);
        const milestoneBar = item.querySelector('.milestone-bar');
        const milestoneId = item.dataset.milestoneId;
        
        // 초기 위치 계산  
        const startPos = dateToPixel(startDate);
        // 종료일의 다음 날 시작 위치까지 포함하여 계산
        const nextDay = new Date(endDate);
        nextDay.setDate(endDate.getDate() + 1);
        const endPos = dateToPixel(nextDay);
        const width = endPos - startPos; // 전체 너비
        
        // 마일스톤 바 위치 설정
        milestoneBar.style.position = 'absolute';
        milestoneBar.style.left = startPos + 'px';
        milestoneBar.style.width = width + 'px';
        milestoneBar.style.top = '20px';
        milestoneBar.style.cursor = 'move';
        
        // 드래그 기능 추가
        let isDragging = false;
        let dragType = null; // 'move', 'resize-start', 'resize-end'
        let startX = 0;
        let originalLeft = 0;
        let originalWidth = 0;
        
        // 마우스 다운 이벤트
        milestoneBar.addEventListener('mousedown', function(e) {
            e.preventDefault();
            isDragging = true;
            startX = e.clientX;
            originalLeft = parseInt(milestoneBar.style.left);
            originalWidth = parseInt(milestoneBar.style.width);
            
            const rect = milestoneBar.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            
            // 드래그 타입 결정 (양쪽 끝 20px는 리사이즈, 나머지는 이동)
            if (mouseX < 20) {
                dragType = 'resize-start';
                milestoneBar.style.cursor = 'w-resize';
            } else if (mouseX > rect.width - 20) {
                dragType = 'resize-end';
                milestoneBar.style.cursor = 'e-resize';
            } else {
                dragType = 'move';
                milestoneBar.style.cursor = 'grabbing';
            }
            
            // 드래그 중 시각적 피드백
            milestoneBar.style.opacity = '0.8';
            milestoneBar.style.zIndex = '1000';
        });
        
        // 날짜 툴팁 요소 생성
        const tooltip = document.createElement('div');
        tooltip.className = 'date-tooltip';
        tooltip.style.cssText = `
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 9999;
            display: none;
            white-space: nowrap;
        `;
        document.body.appendChild(tooltip);

        // 마우스 이동 이벤트
        document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;
            
            const deltaX = e.clientX - startX;
            const scrollContainer = document.querySelector('.timeline-scroll-area');
            const scrollOffset = scrollContainer.scrollLeft;
            
            let newLeft, newWidth;
            
            if (dragType === 'move') {
                // 전체 이동 - 스냅 적용
                const rawLeft = originalLeft + deltaX;
                const snappedPixel = snapToDay(rawLeft);
                newLeft = Math.max(0, Math.min(totalWidth - parseInt(milestoneBar.style.width), snappedPixel));
                milestoneBar.style.left = newLeft + 'px';
                
                // 툴팁 업데이트 (시작일과 종료일)
                const snappedDate = pixelToDate(newLeft);
                const endPixel = newLeft + parseInt(milestoneBar.style.width);
                const endDate = new Date(pixelToDate(endPixel));
                endDate.setDate(endDate.getDate() - 1);
                
                tooltip.textContent = `${formatDateForDisplay(snappedDate)} - ${formatDateForDisplay(endDate)}`;
                tooltip.style.left = (e.clientX + 15) + 'px';
                tooltip.style.top = (e.clientY - 30) + 'px';
                tooltip.style.display = 'block';
                
            } else if (dragType === 'resize-start') {
                // 시작점 리사이즈 - 스냅 적용
                const rawLeft = originalLeft + deltaX;
                const snappedLeft = snapToDay(rawLeft);
                newLeft = Math.max(0, snappedLeft);
                newWidth = Math.max(dayWidth, (originalLeft + originalWidth) - newLeft);
                milestoneBar.style.left = newLeft + 'px';
                milestoneBar.style.width = newWidth + 'px';
                
                // 툴팁 업데이트 (새 시작일)
                const snappedDate = pixelToDate(newLeft);
                tooltip.textContent = `시작: ${formatDateForDisplay(snappedDate)}`;
                tooltip.style.left = (e.clientX + 15) + 'px';
                tooltip.style.top = (e.clientY - 30) + 'px';
                tooltip.style.display = 'block';
                
            } else if (dragType === 'resize-end') {
                // 종료점 리사이즈 - 스냅 적용
                const rawRight = originalLeft + originalWidth + deltaX;
                const snappedRight = snapToDay(rawRight);
                newWidth = Math.max(dayWidth, snappedRight - originalLeft);
                milestoneBar.style.width = newWidth + 'px';
                
                // 툴팁 업데이트 (새 종료일)
                const endPixel = originalLeft + newWidth;
                const endDate = new Date(pixelToDate(endPixel));
                endDate.setDate(endDate.getDate() - 1);
                tooltip.textContent = `종료: ${formatDateForDisplay(endDate)}`;
                tooltip.style.left = (e.clientX + 15) + 'px';
                tooltip.style.top = (e.clientY - 30) + 'px';
                tooltip.style.display = 'block';
            }
        });
        
        // 마우스 업 이벤트
        document.addEventListener('mouseup', function(e) {
            if (!isDragging) return;
            
            isDragging = false;
            milestoneBar.style.opacity = '1';
            milestoneBar.style.zIndex = 'auto';
            milestoneBar.style.cursor = 'move';
            
            // 툴팁 숨기기
            tooltip.style.display = 'none';
            
            // 새로운 날짜 계산
            const newLeft = parseInt(milestoneBar.style.left);
            const newWidth = parseInt(milestoneBar.style.width);
            const newRight = newLeft + newWidth; // 전체 너비
            
            const newStartDate = pixelToDate(newLeft);
            // 종료일은 실제 마지막 날짜로 계산 (다음 날 시작점에서 -1일)
            const nextDayDate = pixelToDate(newRight);
            const newEndDate = new Date(nextDayDate);
            newEndDate.setDate(nextDayDate.getDate() - 1);
            
            // 서버에 업데이트 전송
            console.log('드래그 완료 - 새로운 날짜:', {
                startdate: formatDate(newStartDate),
                enddate: formatDate(newEndDate)
            });
            updateMilestone(milestoneId, {
                startdate: formatDate(newStartDate),
                enddate: formatDate(newEndDate)
            });
        });
    });
    
    // 마일스톤 업데이트 AJAX 함수
    function updateMilestone(milestoneId, data) {
        console.log('AJAX 요청 시작:', {
            url: `/teams/team/{{ team.id }}/milestone/${milestoneId}/update/`,
            data: data
        });
        fetch(`/teams/team/{{ team.id }}/milestone/${milestoneId}/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            console.log('응답 상태:', response.status, response.statusText);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(result => {
            console.log('서버 응답:', result);
            if (result.success) {
                console.log('마일스톤 업데이트 성공:', result.message);
                // 좌측 정보 패널의 날짜 정보도 업데이트
                const infoItem = document.querySelector(`[data-milestone-id="${milestoneId}"]`);
                if (infoItem) {
                    const dateRange = infoItem.querySelector('.date-range');
                    const newStart = new Date(result.milestone.startdate);
                    const newEnd = new Date(result.milestone.enddate);
                    dateRange.textContent = `${(newStart.getMonth()+1).toString().padStart(2,'0')}/${newStart.getDate().toString().padStart(2,'0')} - ${(newEnd.getMonth()+1).toString().padStart(2,'0')}/${newEnd.getDate().toString().padStart(2,'0')}`;
                }
            } else {
                console.error('업데이트 실패:', result.message);
                alert('마일스톤 업데이트에 실패했습니다: ' + result.message);
                location.reload(); // 실패시 페이지 새로고침
            }
        })
        .catch(error => {
            console.error('네트워크 또는 파싱 에러:', error);
            console.error('에러 스택:', error.stack);
            alert(`마일스톤 업데이트 중 오류가 발생했습니다: ${error.message}`);
            location.reload();
        });
    }
    
    // 오늘 날짜 마커 추가
    function addTodayMarker() {
        // 로컬 시간대의 오늘 날짜 (시간 정보 제거 후 다음날로)
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        today.setDate(today.getDate() + 1); // 다음날로 설정
        const todayPixel = dateToPixel(today);
        
        const todayMarker = document.createElement('div');
        todayMarker.className = 'today-marker';
        todayMarker.style.cssText = `
            position: absolute;
            left: ${todayPixel}px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #10b981;
            z-index: 100;
            pointer-events: none;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
        `;
        
        // 오늘 날짜 레이블
        const todayLabel = document.createElement('div');
        todayLabel.className = 'today-label';
        todayLabel.textContent = '오늘';
        todayLabel.style.cssText = `
            position: absolute;
            left: ${todayPixel + 8}px;
            top: 10px;
            background: #10b981;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            z-index: 101;
            pointer-events: none;
            white-space: nowrap;
        `;
        
        scrollContent.appendChild(todayMarker);
        scrollContent.appendChild(todayLabel);
        
        console.log(`오늘 날짜: ${today.getFullYear()}-${(today.getMonth()+1).toString().padStart(2,'0')}-${today.getDate().toString().padStart(2,'0')}`);
        console.log(`오늘 날짜 마커 추가: ${todayPixel}px`);
    }
    
    // 페이지 로드 시 현재 날짜 위치로 스크롤
    function scrollToCurrentDate() {
        // 로컬 시간대의 오늘 날짜 (시간 정보 제거 후 다음날로)
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        today.setDate(today.getDate() + 1); // 다음날로 설정
        const todayPixel = dateToPixel(today);
        const scrollContainer = document.querySelector('.timeline-scroll-area');
        
        // 타임라인 컨테이너 너비의 절반을 빼서 현재 날짜가 중앙에 오도록 조정
        const containerWidth = scrollContainer.clientWidth;
        const scrollPosition = Math.max(0, todayPixel - (containerWidth / 2));
        
        // 부드러운 스크롤 효과
        scrollContainer.scrollTo({
            left: scrollPosition,
            behavior: 'smooth'
        });
        
        console.log(`오늘 날짜 (${today.toDateString()})로 스크롤: ${scrollPosition}px`);
    }
    
    // 오늘 날짜 마커 추가 및 스크롤 실행
    addTodayMarker();
    setTimeout(scrollToCurrentDate, 100);
});
</script>

{% endblock %}