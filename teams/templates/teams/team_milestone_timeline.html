{% extends 'base_app.html' %}
{% load static %}
{% csrf_token %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/teams.css' %}" />
{% endblock %}

{% block extra_js %}
<script>
// 팀 데이터를 전역으로 설정 (JS 파일에서 접근 가능하도록)
window.teamData = {
    id: {{ team.id }},
    csrfToken: "{{ csrf_token }}"
};
</script>
<script src="{% static 'js/pages/milestone_timeline.js' %}"></script>
{% endblock %}

{% block contents %}
<section class="timeline-page">
  <div class="timeline-page-header">
    <div class="timeline-header-left">
      <a href="{% url 'teams:team_main_page' team.id %}" class="back-btn">
        <i class="ri-arrow-left-line"></i>
      </a>
      <div class="timeline-title-section">
        <h2>마일스톤 타임라인</h2>
        <p>팀의 마일스톤을 시각적 타임라인으로 관리하세요</p>
      </div>
    </div>
    <a href="{% url 'teams:team_add_milestone' team.id %}" class="primary-btn">
      <i class="ri-add-line"></i>
      마일스톤 추가
    </a>
  </div>

  <div class="timeline-container">
    <!-- 좌측 고정 영역: 마일스톤 정보 -->
    <div class="milestone-info-fixed">
      <div class="milestone-info-header">
        <h3>마일스톤</h3>
      </div>
      <div class="milestone-info-list">
        {% for milestone in milestones %}
        <div class="milestone-info-item" data-milestone-id="{{ milestone.id }}">
          <div class="milestone-title">{{ milestone.title }}</div>
          <button class="delete-btn" onclick="deleteMilestone({{ milestone.id }}, '{{ milestone.title }}')" title="마일스톤 삭제">
            <i class="ri-delete-bin-line"></i>
          </button>
          <div class="milestone-dates">
            <span class="date-range">{{ milestone.startdate|date:'m/d' }} - {{ milestone.enddate|date:'m/d' }}</span>
          </div>
          <div class="milestone-meta">
            <span class="priority priority-{{ milestone.priority }}">
              {{ milestone.get_priority_display }}
            </span>
            <span class="progress">{{ milestone.progress_percentage }}%</span>
          </div>
        </div>
        {% empty %}
        <div class="empty-milestone-info">
          <p>아직 등록된 마일스톤이 없습니다</p>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- 우측 스크롤 영역: 타임라인 -->
    <div class="timeline-scroll-area">
      <div class="timeline-scroll-content">
        <!-- 헤더 높이 맞춤용 빈 영역 -->
        <div class="timeline-header-spacer" id="monthHeaders">
          <!-- JavaScript로 동적 생성 -->
        </div>

        <!-- 마일스톤 타임라인 -->
        {% for milestone in milestones %}
        <div class="milestone-timeline-item" data-milestone-id="{{ milestone.id }}"
             data-start="{{ milestone.startdate|date:'Y-m-d' }}"
             data-end="{{ milestone.enddate|date:'Y-m-d' }}">
          <div class="milestone-bar priority-{{ milestone.priority }}
                     {% if milestone.is_completed %}completed{% endif %}"
               data-title="{{ milestone.title }}">
            {% comment %} <span>{{ milestone.startdate|date:'m/d' }} - {{ milestone.enddate|date:'m/d' }}</span> {% endcomment %}
          </div>
        </div>
        {% empty %}
        <div class="empty-timeline">
          <i class="ri-calendar-todo-line"></i>
          <p>아직 등록된 마일스톤이 없습니다</p>
          <a href="{% url 'teams:team_add_milestone' team.id %}" class="primary-btn">
            첫 번째 마일스톤 추가하기
          </a>
        </div>
        {% endfor %}

        <!-- 월별 구분선 - JavaScript로 동적 생성 -->

        <!-- 일별 구분선 (디버깅용) -->
      </div>
    </div>
  </div>
  </div>
</section>

<!-- 마일스톤 상세 모달 -->
<div class="modal" id="milestoneModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">마일스톤 상세</h3>
      <button class="modal-close" id="modalClose">
        <i class="ri-close-line"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="milestone-detail" id="milestoneDetail">
        <!-- JavaScript로 동적 생성 -->
      </div>
    </div>
  </div>
</div>

{% endblock %}