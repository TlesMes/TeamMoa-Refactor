{% extends 'base_team.html' %}
{% load static %}
{% csrf_token %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common/modal.css' %}" />
<link rel="stylesheet" href="{% static 'css/pages/teams/timeline.css' %}" />
{% endblock %}

{% block extra_js %}
<script>
// 팀 데이터를 전역으로 설정 (JS 파일에서 접근 가능하도록)
window.teamData = {
    id: {{ team.id }},
    csrfToken: "{{ csrf_token }}"
};
</script>
<!-- API 클라이언트 로드 -->
<script src="{% static 'js/api/client.js' %}"></script>
<script>
// API 클라이언트 인스턴스 생성
const apiClient = new ApiClient();
</script>
<script src="{% static 'js/pages/milestone_timeline.js' %}"></script>
{% endblock %}

{% block contents %}
<section class="timeline-page">
  <div class="timeline-page-header">
    <div class="timeline-header-left">
      <a href="{% url 'teams:team_main_page' team.id %}" class="back-btn">
        <i class="ri-arrow-left-line"></i>
      </a>
      <div class="timeline-title-section">
        <h2>마일스톤 타임라인</h2>
        <p>팀의 마일스톤을 시각적 타임라인으로 관리하세요</p>
      </div>
    </div>

    <!-- 필터 버튼 -->
    <div class="timeline-filters">
      <button class="filter-preset active" data-preset="all">
        <i class="ri-eye-line"></i>
        전체
      </button>
      <button class="filter-preset" data-preset="active">
        <i class="ri-play-circle-line"></i>
        진행중
      </button>
      <button class="filter-preset" data-preset="overdue">
        <i class="ri-alarm-warning-line"></i>
        지연
      </button>
      <button class="filter-preset" data-preset="incomplete">
        <i class="ri-checkbox-multiple-line"></i>
        완료 제외
      </button>
    </div>

    <button class="primary-btn" id="addMilestoneBtn">
      <i class="ri-add-line"></i>
      마일스톤 추가
    </button>
  </div>

  <div class="timeline-container">
    <!-- 좌측 고정 영역: 마일스톤 정보 -->
    <div class="milestone-info-fixed">
      <div class="milestone-info-header">
        <h3>마일스톤</h3>
      </div>
      <div class="milestone-info-list">
        {% for milestone in milestones %}
        <div class="milestone-info-item"
             data-milestone-id="{{ milestone.id }}"
             data-status="{{ milestone.get_status }}"
             data-priority="{{ milestone.priority }}">
          <div class="milestone-title">{{ milestone.title }}</div>
          <button class="delete-btn" onclick="deleteMilestone({{ milestone.id }}, '{{ milestone.title }}')" title="마일스톤 삭제">
            <i class="ri-delete-bin-line"></i>
          </button>
          <div class="milestone-dates">
            <span class="date-range">{{ milestone.startdate|date:'m/d' }} - {{ milestone.enddate|date:'m/d' }}</span>
          </div>
          <div class="milestone-meta">
            <span class="priority priority-{{ milestone.priority }}">
              {{ milestone.get_priority_display }}
            </span>
            <span class="progress">{{ milestone.progress_percentage }}%</span>
          </div>
        </div>
        {% empty %}
        <div class="empty-milestone-info">
          <p>아직 등록된 마일스톤이 없습니다</p>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- 우측 스크롤 영역: 타임라인 -->
    <div class="timeline-scroll-area">
      <div class="timeline-scroll-content">
        <!-- 헤더 높이 맞춤용 빈 영역 -->
        <div class="timeline-header-spacer" id="monthHeaders">
          <!-- JavaScript로 동적 생성 -->
        </div>

        <!-- 마일스톤 타임라인 -->
        {% for milestone in milestones %}
        <div class="milestone-timeline-item"
             data-milestone-id="{{ milestone.id }}"
             data-start="{{ milestone.startdate|date:'Y-m-d' }}"
             data-end="{{ milestone.enddate|date:'Y-m-d' }}"
             data-status="{{ milestone.get_status }}"
             data-priority="{{ milestone.priority }}">
          <div class="milestone-bar priority-{{ milestone.priority }}
                     {% if milestone.is_completed %}completed{% endif %}"
               data-title="{{ milestone.title }}">
            {% comment %} <span>{{ milestone.startdate|date:'m/d' }} - {{ milestone.enddate|date:'m/d' }}</span> {% endcomment %}
          </div>
        </div>
        {% empty %}
        <div class="empty-timeline">
          <i class="ri-calendar-todo-line"></i>
          <p>아직 등록된 마일스톤이 없습니다</p>
          <button class="primary-btn" onclick="document.getElementById('addMilestoneBtn').click()">
            첫 번째 마일스톤 추가하기
          </button>
        </div>
        {% endfor %}

        <!-- 월별 구분선 - JavaScript로 동적 생성 -->

        <!-- 일별 구분선 (디버깅용) -->
      </div>
    </div>
  </div>
  </div>
</section>

<!-- 마일스톤 상세 모달 -->
<div class="modal" id="milestoneModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">마일스톤 상세</h3>
      <button class="modal-close" id="modalClose">
        <i class="ri-close-line"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="milestone-detail" id="milestoneDetail">
        <!-- JavaScript로 동적 생성 -->
      </div>
    </div>
  </div>
</div>

<!-- 마일스톤 생성 모달 -->
<div class="modal" id="createMilestoneModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>마일스톤 추가</h3>
      <button class="modal-close" id="createModalClose">
        <i class="ri-close-line"></i>
      </button>
    </div>
    <div class="modal-body">
      <form id="createMilestoneForm">
        {% csrf_token %}

        <div class="date-range-group">
          <div class="form-group">
            <label for="startdate">시작일</label>
            <div class="input-wrapper">
              <i class="ri-calendar-line"></i>
              <input type="date" id="startdate" name="startdate">
            </div>
          </div>

          <div class="form-group">
            <label for="enddate">종료일</label>
            <div class="input-wrapper">
              <i class="ri-calendar-check-line"></i>
              <input type="date" id="enddate" name="enddate">
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="title">마일스톤 제목</label>
          <div class="input-wrapper">
            <i class="ri-flag-line"></i>
            <input type="text" id="title" name="title" maxlength="100" placeholder="마일스톤 제목 입력">
          </div>
        </div>

        <div class="form-group">
          <label for="description">마일스톤 설명</label>
          <div class="textarea-wrapper">
            <i class="ri-file-text-line"></i>
            <textarea id="description" name="description" rows="4" placeholder="마일스톤 설명을 입력하세요"></textarea>
          </div>
        </div>

        <div class="form-group">
          <label for="priority">우선순위</label>
          <div class="input-wrapper">
            <i class="ri-star-line"></i>
            <select id="priority" name="priority">
              <option value="critical">최우선</option>
              <option value="high">중요</option>
              <option value="medium" selected>보통</option>
              <option value="low">낮음</option>
              <option value="minimal">미미</option>
            </select>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="create-btn">
            <i class="ri-add-line"></i>
            마일스톤 추가
          </button>
          <button type="button" class="cancel-btn" id="createCancelBtn">
            <i class="ri-close-line"></i>
            취소
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}