{% extends 'base_app.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/teams.css' %}" />
{% endblock %}

{% block contents %}
<section class="timeline-page">
  <div class="timeline-page-header">
    <div class="timeline-header-left">
      <a href="{% url 'teams:team_main_page' team.id %}" class="back-btn">
        <i class="ri-arrow-left-line"></i>
      </a>
      <div class="timeline-title-section">
        <h2>마일스톤 타임라인</h2>
        <p>팀의 마일스톤을 시각적 타임라인으로 관리하세요</p>
      </div>
    </div>
    <a href="{% url 'teams:team_add_milestone' team.id %}" class="primary-btn">
      <i class="ri-add-line"></i>
      마일스톤 추가
    </a>
  </div>

  <div class="timeline-container">
    <!-- 좌측 고정 영역: 마일스톤 정보 -->
    <div class="milestone-info-fixed">
      <div class="milestone-info-header">
        <h3>마일스톤</h3>
      </div>
      <div class="milestone-info-list">
        {% for milestone in milestones %}
        <div class="milestone-info-item" data-milestone-id="{{ milestone.id }}">
          <div class="milestone-title">{{ milestone.title }}</div>
          <div class="milestone-dates">
            <span class="date-range">{{ milestone.startdate|date:'m/d' }} - {{ milestone.enddate|date:'m/d' }}</span>
          </div>
          <div class="milestone-meta">
            <span class="priority priority-{{ milestone.priority }}">
              {{ milestone.get_priority_display }}
            </span>
            <span class="progress">{{ milestone.progress_percentage }}%</span>
          </div>
        </div>
        {% empty %}
        <div class="empty-milestone-info">
          <p>아직 등록된 마일스톤이 없습니다</p>
        </div>
        {% endfor %}
      </div>
    </div>
    
    <!-- 우측 스크롤 영역: 타임라인 -->
    <div class="timeline-scroll-area">
      <div class="timeline-scroll-content">
        <!-- 헤더 높이 맞춤용 빈 영역 -->
        <div class="timeline-header-spacer">
          <!-- 월별 헤더 표시 -->
          <div class="month-header" style="left: 0px; width: 400px;">1월</div>
          <div class="month-header" style="left: 400px; width: 400px;">2월</div>
          <div class="month-header" style="left: 800px; width: 400px;">3월</div>
          <div class="month-header" style="left: 1200px; width: 400px;">4월</div>
          <div class="month-header" style="left: 1600px; width: 400px;">5월</div>
          <div class="month-header" style="left: 2000px; width: 400px;">6월</div>
          <div class="month-header" style="left: 2400px; width: 400px;">7월</div>
          <div class="month-header" style="left: 2800px; width: 400px;">8월</div>
          <div class="month-header" style="left: 3200px; width: 400px;">9월</div>
          <div class="month-header" style="left: 3600px; width: 400px;">10월</div>
          <div class="month-header" style="left: 4000px; width: 400px;">11월</div>
          <div class="month-header" style="left: 4400px; width: 400px;">12월</div>
        </div>
        
        <!-- 마일스톤 타임라인 -->
        {% for milestone in milestones %}
        <div class="milestone-timeline-item" data-milestone-id="{{ milestone.id }}" 
             data-start="{{ milestone.startdate|date:'Y-m-d' }}"
             data-end="{{ milestone.enddate|date:'Y-m-d' }}">
          <div class="milestone-bar priority-{{ milestone.priority }} 
                     {% if milestone.is_completed %}completed{% endif %}">
            {% comment %} <span>{{ milestone.startdate|date:'m/d' }} - {{ milestone.enddate|date:'m/d' }}</span> {% endcomment %}
          </div>
        </div>
        {% empty %}
        <div class="empty-timeline">
          <i class="ri-calendar-todo-line"></i>
          <p>아직 등록된 마일스톤이 없습니다</p>
          <a href="{% url 'teams:team_add_milestone' team.id %}" class="primary-btn">
            첫 번째 마일스톤 추가하기
          </a>
        </div>
        {% endfor %}
        
        <!-- 월별 구분선 -->
        <div class="month-marker" style="left: 400px;"></div>
        <div class="month-marker" style="left: 800px;"></div>
        <div class="month-marker" style="left: 1200px;"></div>
        <div class="month-marker" style="left: 1600px;"></div>
        <div class="month-marker" style="left: 2000px;"></div>
        <div class="month-marker" style="left: 2400px;"></div>
        <div class="month-marker" style="left: 2800px;"></div>
        <div class="month-marker" style="left: 3200px;"></div>
        <div class="month-marker" style="left: 3600px;"></div>
        <div class="month-marker" style="left: 4000px;"></div>
        <div class="month-marker" style="left: 4400px;"></div>
        
        <!-- 일별 구분선 (디버깅용) -->
      </div>
    </div>
  </div>
  </div>
</section>

<!-- 마일스톤 상세 모달 -->
<div class="modal" id="milestoneModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">마일스톤 상세</h3>
      <button class="modal-close" id="modalClose">
        <i class="ri-close-line"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="milestone-detail" id="milestoneDetail">
        <!-- JavaScript로 동적 생성 -->
      </div>
    </div>
  </div>
</div>

<script>
// 간단한 마일스톤 배치 스크립트
document.addEventListener('DOMContentLoaded', function() {
    const scrollContent = document.querySelector('.timeline-scroll-content');
    
    // 일별 구분선 생성 (디버깅용)
    for (let month = 0; month < 12; month++) {
        for (let day = 1; day <= 31; day++) {
            const dayPos = (month * 400) + ((day - 1) * 13);
            if (dayPos < 4800) { // 전체 너비 내에서만
                const dayMarker = document.createElement('div');
                dayMarker.className = 'day-marker';
                dayMarker.style.cssText = `
                    position: absolute;
                    left: ${dayPos}px;
                    top: 0;
                    bottom: 0;
                    width: 1px;
                    background: rgba(200, 200, 200, 0.3);
                    pointer-events: none;
                `;
                scrollContent.appendChild(dayMarker);
            }
        }
    }
    
    const milestoneItems = document.querySelectorAll('.milestone-timeline-item');
    
    milestoneItems.forEach(item => {
        const startDate = new Date(item.dataset.start);
        const endDate = new Date(item.dataset.end);
        const milestoneBar = item.querySelector('.milestone-bar');
        
        // 사이즈 계산 (간단하게 1월 = 400px 기준)
        const startMonth = startDate.getMonth(); // 0~11
        const endMonth = endDate.getMonth();
        const startDay = startDate.getDate();
        const endDay = endDate.getDate();
        
        const startPos = (startMonth * 400) + ((startDay - 1) * 13); // startDay-1로 수정
        const endPos = (endMonth * 400) + (endDay * 13); // endDay는 그대로 (끝나는 날까지 포함)
        const width = endPos - startPos
        
        // 마일스톤 바 위치 설정
        milestoneBar.style.position = 'absolute';
        milestoneBar.style.left = startPos + 'px';
        milestoneBar.style.width = width + 'px';
        milestoneBar.style.top = '20px';
    });
});
</script>

{% endblock %}