{% extends 'base_app.html' %} {% load static %} {% block contents %}

<section class="mainsection">
  {% if request.user.is_authenticated %}
  <div class="datediv">
    <h2>
      {{today_date|date:'오늘은 Y년 m월 d일'}}, <span>{{today_milestone}}</span>
    </h2>
    <!-- 마일스톤 요약 섹션 -->
    <div class="milestone-summary">
      {% if milestones %}
        <div class="milestone-cards">
          <div class="milestone-card card-total">
            <div class="card-icon">
              <i class="ri-bookmark-line"></i>
            </div>
            <div class="card-content">
              <span class="card-number">{{ milestones|length }}</span>
              <span class="card-label">전체</span>
            </div>
          </div>
          
          <div class="milestone-card card-not-started">
            <div class="card-icon">
              <i class="ri-pause-circle-line"></i>
            </div>
            <div class="card-content">
              <span class="card-number">{{ not_started_count }}</span>
              <span class="card-label">시작 전</span>
            </div>
          </div>
          
          <div class="milestone-card card-in-progress">
            <div class="card-icon">
              <i class="ri-play-circle-line"></i>
            </div>
            <div class="card-content">
              <span class="card-number">{{ in_progress_count }}</span>
              <span class="card-label">진행 중</span>
            </div>
          </div>
          
          <div class="milestone-card card-completed">
            <div class="card-icon">
              <i class="ri-checkbox-circle-line"></i>
            </div>
            <div class="card-content">
              <span class="card-number">{{ completed_count }}</span>
              <span class="card-label">완료됨</span>
            </div>
          </div>
          
          {% if overdue_count > 0 %}
          <div class="milestone-card card-overdue">
            <div class="card-icon">
              <i class="ri-error-warning-line"></i>
            </div>
            <div class="card-content">
              <span class="card-number">{{ overdue_count }}</span>
              <span class="card-label">지연됨</span>
            </div>
          </div>
          {% endif %}
        </div>
        
        <div class="milestone-actions">
          <a href="{% url 'teams:team_milestone_timeline' team.id %}" class="timeline-link">
            <i class="ri-timeline-view"></i>
            <span>마일스톤 타임라인에서 보기</span>
            <i class="ri-arrow-right-line"></i>
          </a>
        </div>
      {% else %}
        <div class="no-milestones">
          <i class="ri-calendar-todo-line"></i>
          <p>아직 등록된 마일스톤이 없습니다</p>
          {% if request.user == team.host %}
          <a href="{% url 'teams:team_add_milestone' team.id %}" class="add-milestone-link">
            첫 번째 마일스톤 추가하기
          </a>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>
  <div class="teamdiv">
    <div class="team-header">
      <div class="team-info">
        <h2>
          {{ team.title }}
          <span class="team-code">(#<span id="copycode">{{team.invitecode}}</span>)</span>
          <button id="copybtn">
            <svg
              width="20"
              height="19" 
              viewBox="0 0 27 30" 
              fill="none" 
              xmlns="http://www.w3.org/2000/svg"
            >
              <path 
                d="M26.1527 3.86373L23.0259 0.82377C22.4834 0.296323 21.7476 3.90045e-06 20.9803 0L10.6071 0C9.00944 0 7.71429 1.25918 7.71429 2.8125V5.625H2.89286C1.29516 5.625 0 6.88418 0 8.4375V27.1875C0 28.7408 1.29516 30 2.89286 30H16.3929C17.9906 30 19.2857 28.7408 19.2857 27.1875V24.375H24.1071C25.7048 24.375 27 23.1158 27 21.5625V5.85246C27 5.10654 26.6952 4.39117 26.1527 3.86373ZM16.0312 27.1875H3.25446C3.15856 27.1875 3.06658 27.1505 2.99877 27.0845C2.93096 27.0186 2.89286 26.9292 2.89286 26.8359V8.78906C2.89286 8.69582 2.93096 8.6064 2.99877 8.54047C3.06658 8.47454 3.15856 8.4375 3.25446 8.4375H7.71429V21.5625C7.71429 23.1158 9.00944 24.375 10.6071 24.375H16.3929V26.8359C16.3929 26.9292 16.3548 27.0186 16.2869 27.0845C16.2191 27.1505 16.1272 27.1875 16.0312 27.1875ZM23.7455 21.5625H10.9688C10.8728 21.5625 10.7809 21.5255 10.7131 21.4595C10.6452 21.3936 10.6071 21.3042 10.6071 21.2109V3.16406C10.6071 3.07082 10.6452 2.9814 10.7131 2.91547C10.7809 2.84954 10.8728 2.8125 10.9688 2.8125H17.3571V7.96875C17.3571 8.74541 18.0047 9.375 18.8036 9.375H24.1071V21.2109C24.1071 21.3042 24.069 21.3936 24.0012 21.4595C23.9334 21.5255 23.8414 21.5625 23.7455 21.5625ZM24.1071 6.5625H20.25V2.8125H20.8305C20.9264 2.8125 21.0184 2.84953 21.0862 2.91545L24.0013 5.74951C24.0348 5.78216 24.0615 5.82092 24.0796 5.86358C24.0978 5.90624 24.1071 5.95195 24.1071 5.99812V6.5625Z" 
                fill="#2D3D57"
              />
            </svg>
          </button>
        </h2>
        <h3>{{team.introduction}}</h3>
      </div>
      <div class="editdiv">
        {% if request.user == team.host %}
        <a href="{% url 'teams:team_add_milestone' team.id %}">
          <button class="plusbtn">개발 단계 추가</button>
        </a>
        <a href="{% url 'teams:team_milestone_timeline' team.id %}">
          <button class="timeline-btn">
            <i class="ri-timeline-view"></i>
            타임라인 보기
          </button>
        </a>
        <a href="{% url 'teams:team_info_change' team.id %}">
          <button class="plusbtn2">팀 정보 수정</button>
        </a>
        <button class="delete-btn" id="disband-team-btn" data-team-title="{{ team.title }}">팀 해산</button>
        {% endif %}
      </div>
    </div>
    
    <div class="team-members">
      <div class="member-list">
        <div class="member-item leader">
          <div>
            <span class="member-name">{{ team.host.nickname }}</span>
            <span class="member-role">팀장</span>
          </div>
          <span class="member-login">{{ team.host.last_login|date:'Y-m-d, H:i:s' }}</span>
        </div>
        {% for member in members %}
        {% if member.user != team.host %}
        <div class="member-item">
          <div>
            <span class="member-name">{{member.user.nickname}}</span>
            <span class="member-role">팀원</span>
          </div>
          <span class="member-login">{{member.user.last_login|date:'Y-m-d, H:i:s'}}</span>
        </div>
        {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- 팀 해산을 위한 숨겨진 폼 -->
  <form id="disband-form" method="POST" action="{% url 'teams:team_disband' team.id %}" style="display: none;">
    {% csrf_token %}
  </form>

  <style>
    .modal {
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: white;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px 0 24px;
    }

    .modal-header h3 {
      margin: 0;
      color: #333;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-body {
      padding: 20px 24px;
    }

    .warning-message {
      text-align: center;
    }

    .warning-message i {
      font-size: 48px;
      color: #f59e0b;
      margin-bottom: 16px;
    }

    .warning-message p {
      margin: 8px 0;
      color: #333;
    }

    .warning-text {
      color: #666 !important;
      font-size: 14px;
    }

    .modal-footer {
      padding: 0 24px 24px 24px;
    }

    .modal-footer form {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-danger {
      background-color: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background-color: #dc2626;
    }

    .btn-secondary {
      background-color: #6b7280;
      color: white;
    }

    .btn-secondary:hover {
      background-color: #4b5563;
    }
  </style>

  <script>
    const copyClipboard = () => {
      const text = document.getElementById("copycode").textContent;
      const textarea = document.createElement("textarea");
      textarea.textContent = text;
      document.body.append(textarea);
      textarea.select();
      document.execCommand("copy");
      textarea.remove();
      showToast("팀코드가 복사되었습니다");
    };

    const button = document.getElementById("copybtn");
    button.addEventListener("click", copyClipboard);

    // 팀 해산 버튼 이벤트
    const disbandTeamBtn = document.getElementById('disband-team-btn');
    if (disbandTeamBtn) {
      disbandTeamBtn.addEventListener('click', function(e) {
        e.preventDefault();
        const teamTitle = this.dataset.teamTitle;
        showConfirmModal(`"${teamTitle}" 팀을 정말로 해산하시겠습니까?\n해산된 팀은 복구할 수 없습니다.`, () => {
          document.getElementById('disband-form').submit();
        });
      });
    }
  </script>
  {% endif %}
</section>
{% endblock %}
