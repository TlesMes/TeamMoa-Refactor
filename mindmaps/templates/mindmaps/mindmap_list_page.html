{% extends 'base_app.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common/modal.css' %}">
<link rel="stylesheet" href="{% static 'css/pages/mindmaps/common.css' %}">
<link rel="stylesheet" href="{% static 'css/pages/mindmaps/mindmap_list.css' %}">
{% endblock %}

{% block contents %}
{% comment %} Light theme styles loaded in base_app.html {% endcomment %}
<section class="mindmapsection">
  <div class="mindmap-header">
    <h1>ë§ˆì¸ë“œë§µ ëª©ë¡</h1>
    <button class="create-btn" id="createMindmapBtn">
      <i class="ri-add-line"></i>
      ë§ˆì¸ë“œë§µ ìƒì„±
    </button>
  </div>
  
  {% if mindmaps %}
  <div class="mindmap-grid">
    {% for mindmap in mindmaps %}
    <div class="mindmap-card">
      <h3 class="mindmap-title">{{ mindmap.title }}</h3>
      <div class="mindmap-actions">
        <button class="view-btn view-mindmap-btn" data-view-url="{% url 'mindmaps:mindmap_detail_page' team.id mindmap.id %}">
          ë³´ê¸°
        </button>
        {% if request.user == team.host %}
        <button class="delete-btn delete-mindmap-btn" data-delete-url="{% url 'mindmaps:mindmap_delete' team.id mindmap.id %}">
          ì‚­ì œ
        </button>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="empty-state">
    <div class="empty-icon">ğŸ§ </div>
    <h3>ì•„ì§ ë§ˆì¸ë“œë§µì´ ì—†ìŠµë‹ˆë‹¤</h3>
    <p>íŒ€ì˜ ì²« ë²ˆì§¸ ë§ˆì¸ë“œë§µì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
    <button class="empty-create-btn" id="emptyCreateBtn">
      <i class="ri-add-circle-line"></i>
      ë§ˆì¸ë“œë§µ ìƒì„±í•˜ê¸°
    </button>
  </div>
  {% endif %}
</section>

<!-- ë§ˆì¸ë“œë§µ ìƒì„± ëª¨ë‹¬ -->
<div class="modal" id="createMindmapModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ìƒˆ ë§ˆì¸ë“œë§µ ë§Œë“¤ê¸°</h3>
      <button class="modal-close" id="createModalClose">
        <i class="ri-close-line"></i>
      </button>
    </div>
    <div class="modal-body">
      <form id="createMindmapForm">
        {% csrf_token %}

        <div class="form-group">
          <label for="mindmap_title">ë§ˆì¸ë“œë§µ ì œëª©</label>
          <div class="input-wrapper">
            <i class="ri-mind-map"></i>
            <input type="text" id="mindmap_title" name="title" maxlength="100" placeholder="ë§ˆì¸ë“œë§µ ì œëª© ì…ë ¥" required>
          </div>
          <div class="help-text">
            <small>íŒ€ì˜ ì•„ì´ë””ì–´ë¥¼ ì‹œê°ì ìœ¼ë¡œ êµ¬ì¡°í™”í•˜ì„¸ìš”</small>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="create-btn">
            <i class="ri-add-circle-line"></i>
            ë§ˆì¸ë“œë§µ ìƒì„±í•˜ê¸°
          </button>
          <button type="button" class="cancel-btn" id="createCancelBtn">
            <i class="ri-close-line"></i>
            ì·¨ì†Œ
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const teamId = {{ team.id }};

    // ë§ˆì¸ë“œë§µ ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
    const viewBtns = document.querySelectorAll('.view-mindmap-btn');
    viewBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const viewUrl = this.dataset.viewUrl;
            window.location.href = viewUrl;
        });
    });

    // ë§ˆì¸ë“œë§µ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
    const deleteBtns = document.querySelectorAll('.delete-mindmap-btn');
    deleteBtns.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const deleteUrl = this.dataset.deleteUrl;
            showConfirmModal('ì •ë§ë¡œ ì´ ë§ˆì¸ë“œë§µì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
                // ë™ì  POST í¼ ìƒì„±
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = deleteUrl;
                form.style.display = 'none';

                // CSRF í† í° ì¶”ê°€ (Djangoì—ì„œ ì œê³µ)
                const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value ||
                                  '{{ csrf_token }}';

                const hiddenField = document.createElement('input');
                hiddenField.type = 'hidden';
                hiddenField.name = 'csrfmiddlewaretoken';
                hiddenField.value = csrfToken;
                form.appendChild(hiddenField);

                document.body.appendChild(form);
                form.submit();
            });
        });
    });

    // ========================================
    // ë§ˆì¸ë“œë§µ ìƒì„± ëª¨ë‹¬
    // ========================================
    const modal = document.getElementById('createMindmapModal');
    const openBtn = document.getElementById('createMindmapBtn');
    const emptyOpenBtn = document.getElementById('emptyCreateBtn');
    const closeBtn = document.getElementById('createModalClose');
    const cancelBtn = document.getElementById('createCancelBtn');
    const form = document.getElementById('createMindmapForm');

    // ëª¨ë‹¬ ì—´ê¸°
    function openModal() {
        modal.classList.add('active');
        document.getElementById('mindmap_title').focus();
    }

    if (openBtn) {
        openBtn.addEventListener('click', openModal);
    }

    if (emptyOpenBtn) {
        emptyOpenBtn.addEventListener('click', openModal);
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeModal() {
        modal.classList.remove('active');
        form.reset();
    }

    closeBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });

    // í¼ ì œì¶œ
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const title = document.getElementById('mindmap_title').value.trim();

        if (!title) {
            showDjangoToast('ë§ˆì¸ë“œë§µ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('title', title);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        try {
            await fetch("{% url 'mindmaps:mindmap_create' team.id %}", {
                method: 'POST',
                body: formData,
                redirect: 'manual'  // redirect ìë™ ë”°ë¼ê°€ì§€ ì•ŠìŒ (messages ë³´ì¡´)
            });
            // ì„±ê³µ/ì‹¤íŒ¨ ëª¨ë‘ ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™í•˜ì—¬ Django messages í‘œì‹œ
            window.location.href = "{% url 'mindmaps:mindmap_list_page' team.id %}";
        } catch (error) {
            console.error('ë§ˆì¸ë“œë§µ ìƒì„± ìš”ì²­ ì‹¤íŒ¨:', error);
            showDjangoToast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    });
});
</script>

{% endblock %}
